<!DOCTYPE html><html lang="en"><head><base href="/advanced-static-site"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0"/><meta name="description" content="A browser based multi-threaded downloader implemented in vanilla JavaScript. Fetches parts of a file using the HTTP Range header and downloads those pieces i..."><meta name="theme-color" content="#0d5173"><meta name="msapplication-navbutton-color" content="#0d5173"><meta name="apple-mobile-web-app-status-bar-style" content="#0d5173"><meta property="og:image" content="https://chpmnrssll.github.io/assets/images/pixelavatar.png"/><link rel="alternate" type="application/rss+xml" title="Russell Chapman" href="/advanced-static-site/feed.xml"><title>Multithreaded Downloader | Russell Chapman</title><meta name="generator" content="Jekyll v3.6.3"/><meta property="og:title" content="Multithreaded Downloader"/><meta name="author" content="Russell Chapman"/><meta property="og:locale" content="en_US"/><meta name="description" content="A browser based multi-threaded downloader implemented in vanilla JavaScript. Fetches parts of a file using the HTTP Range header and downloads those pieces in parallel. When the pieces have all been downloaded, the original file is re-assembled and saved in the browser’s Downloads folder."/><meta property="og:description" content="A browser based multi-threaded downloader implemented in vanilla JavaScript. Fetches parts of a file using the HTTP Range header and downloads those pieces in parallel. When the pieces have all been downloaded, the original file is re-assembled and saved in the browser’s Downloads folder."/><link rel="canonical" href="https://chpmnrssll.github.io/advanced-static-site/article/2018/08/27/Multithread.html"/><meta property="og:url" content="https://chpmnrssll.github.io/advanced-static-site/article/2018/08/27/Multithread.html"/><meta property="og:site_name" content="Russell Chapman"/><meta property="og:image" content="https://chpmnrssll.github.io/advanced-static-site/assets/images/backgrounds/servers.svg"/><meta property="og:type" content="article"/><meta property="article:published_time" content="2018-08-27T00:00:00+00:00"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@chpmnrssll"/><meta name="twitter:creator" content="@Russell Chapman"/> <script type="application/ld+json">
{"description":"A browser based multi-threaded downloader implemented in vanilla JavaScript. Fetches parts of a file using the HTTP Range header and downloads those pieces in parallel. When the pieces have all been downloaded, the original file is re-assembled and saved in the browser’s Downloads folder.","image":"https://chpmnrssll.github.io/advanced-static-site/assets/images/backgrounds/servers.svg","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://chpmnrssll.github.io/advanced-static-site/article/2018/08/27/Multithread.html"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://chpmnrssll.github.io/advanced-static-site/assets/images/pixelavatar.png"},"name":"Russell Chapman"},"url":"https://chpmnrssll.github.io/advanced-static-site/article/2018/08/27/Multithread.html","headline":"Multithreaded Downloader","dateModified":"2018-08-27T00:00:00+00:00","datePublished":"2018-08-27T00:00:00+00:00","author":{"@type":"Person","name":"Russell Chapman"},"@context":"http://schema.org"}</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-102033116-5"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-36647530-3")</script><meta name="theme-color" content="#537895"/><link rel="manifest" href="/advanced-static-site/assets/manifest.e5668bf01f9fcfa8cb4d264da00e63e2.json"/><link rel="apple-touch-icon" sizes="57x57" href="/advanced-static-site/assets/icons-17561a1604d464cca4e0b5b5384dfa51/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/advanced-static-site/assets/icons-17561a1604d464cca4e0b5b5384dfa51/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/advanced-static-site/assets/icons-17561a1604d464cca4e0b5b5384dfa51/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/advanced-static-site/assets/icons-17561a1604d464cca4e0b5b5384dfa51/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/advanced-static-site/assets/icons-17561a1604d464cca4e0b5b5384dfa51/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/advanced-static-site/assets/icons-17561a1604d464cca4e0b5b5384dfa51/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/advanced-static-site/assets/icons-17561a1604d464cca4e0b5b5384dfa51/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/advanced-static-site/assets/icons-17561a1604d464cca4e0b5b5384dfa51/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/advanced-static-site/assets/icons-17561a1604d464cca4e0b5b5384dfa51/apple-touch-icon-180x180.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="advanced-static-site"><meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" content="#fff"><meta name="application-name" content="advanced-static-site"><link rel="icon" type="image/png" sizes="32x32" href="/advanced-static-site/assets/icons-17561a1604d464cca4e0b5b5384dfa51/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/advanced-static-site/assets/icons-17561a1604d464cca4e0b5b5384dfa51/favicon-16x16.png"><link rel="shortcut icon" href="/advanced-static-site/assets/icons-17561a1604d464cca4e0b5b5384dfa51/favicon.ico"><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 480px) and (-webkit-device-pixel-ratio: 1)" href="/advanced-static-site/assets/icons-17561a1604d464cca4e0b5b5384dfa51/apple-touch-startup-image-320x460.png"><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 480px) and (-webkit-device-pixel-ratio: 2)" href="/advanced-static-site/assets/icons-17561a1604d464cca4e0b5b5384dfa51/apple-touch-startup-image-640x920.png"><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)" href="/advanced-static-site/assets/icons-17561a1604d464cca4e0b5b5384dfa51/apple-touch-startup-image-640x1096.png"><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)" href="/advanced-static-site/assets/icons-17561a1604d464cca4e0b5b5384dfa51/apple-touch-startup-image-750x1294.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (orientation: landscape) and (-webkit-device-pixel-ratio: 3)" href="/advanced-static-site/assets/icons-17561a1604d464cca4e0b5b5384dfa51/apple-touch-startup-image-1182x2208.png"><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (orientation: portrait) and (-webkit-device-pixel-ratio: 3)" href="/advanced-static-site/assets/icons-17561a1604d464cca4e0b5b5384dfa51/apple-touch-startup-image-1242x2148.png"><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (orientation: landscape) and (-webkit-device-pixel-ratio: 1)" href="/advanced-static-site/assets/icons-17561a1604d464cca4e0b5b5384dfa51/apple-touch-startup-image-748x1024.png"><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (orientation: portrait) and (-webkit-device-pixel-ratio: 1)" href="/advanced-static-site/assets/icons-17561a1604d464cca4e0b5b5384dfa51/apple-touch-startup-image-768x1004.png"><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (orientation: landscape) and (-webkit-device-pixel-ratio: 2)" href="/advanced-static-site/assets/icons-17561a1604d464cca4e0b5b5384dfa51/apple-touch-startup-image-1496x2048.png"><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (orientation: portrait) and (-webkit-device-pixel-ratio: 2)" href="/advanced-static-site/assets/icons-17561a1604d464cca4e0b5b5384dfa51/apple-touch-startup-image-1536x2008.png"><link href="/advanced-static-site/assets/app.css" rel="stylesheet"></head><body><nav class="navigation navigation--hidden" role="navigation"> <button class="navigation__button navigation__button--close" aria-label="Close Navigation"> <i class="fa fa-times">x</i> </button> <section class="navigation__categories"><h4>Categories</h4> <a class="navigation__link" href="/advanced-static-site/">Home</a> <a class="navigation__link" href="/advanced-static-site/article/">Articles</a> <a class="navigation__link" href="/advanced-static-site/demo/">Demos</a> <a class="navigation__link" href="/advanced-static-site/news/">News</a> <a class="navigation__link" href="/advanced-static-site/about/">About</a> </section> </nav><nav class="navigation__overlay"> <button class="navigation__button navigation__button--open" aria-label="Open Navigation"> <i class="fa fa-bars">=</i> </button> <button class="navigation__button navigation__button--update navigation--hidden" aria-label="Updates Available"> <i class="fa fa-refresh"></i> </button> <button class="navigation__button navigation__button--top" aria-label="Scroll to top"> <i class="fa fa-chevron-up"></i> </button> </nav><main> <section class="content"> <article class="article" itemscope itemtype="http://schema.org/BlogPosting"><div class="article__image gradient-overlay--alt"> <img class="article__image" itemprop="image" src="/advanced-static-site/assets/images/backgrounds/servers.svg" alt="alt"></div> <header class="article__header"><h1 class="article__title animated-headline fit__text" itemprop="name headline">Multithreaded Downloader</h1><div class="article__meta"> <time datetime="2018-08-27T00:00:00+00:00" itemprop="datePublished"> Aug 27, 2018 </time></div> </header><div class="article__content" itemprop="articleBody"><p>A browser based multi-threaded downloader implemented in vanilla JavaScript. Fetches parts of a file using the HTTP Range header and downloads those pieces in parallel. When the pieces have all been downloaded, the original file is re-assembled and saved in the browser’s Downloads folder.</p><h2 id="requirements">Requirements</h2><p>The downloader should fetch the file directly from the web browser without a server needed to proxy the file. The download process should not need any client software or browser plugin to be installed. It should allow for resuming an interrupted download, or at least retrying a part of the file that was interrupted.</p><p>This project will allow us to specify the number of download threads and the size of each request… so we can tune it for specific network conditions, if that is necessary.</p><ul><li>Sends HTTP HEAD request to get the file info and calculate number of chunks</li><li>Sends HTTP GET requests with “Range: bytes=start-end” header for each chunk</li><li>Monitor the progress of each response stream</li></ul><p>100% client side JavaScript, no plug-ins or proxy required</p><h2 id="methods">Methods</h2><h3 id="adownload">a[download]</h3><ul><li>WhatWG Web Streams</li><li>Memory limit</li><li>Blob</li></ul><h3 id="streamsaverjs">StreamSaver.js</h3><ul><li>Uses <a href="https://github.com/jimmywarting/StreamSaver.js">StreamSaver.js</a> to simplify downloading the output stream.</li><li>Concatenates each response stream (in order) into a final output stream</li><li>Cross-origin dependency (mitm.html)</li><li>Service worker timeout</li><li>WhatWG Web Streams</li><li><a href="https://github.com/creatorrr/web-streams-polyfill">Web Streams Polyfill</a></li></ul><h3 id="html5-filesystem-api">HTML5 FileSystem API</h3><ul><li>Uses <a href="https://github.com/vitalets/bro-fs">Bro-fs</a> (HTML5 Filesystem api) to temporarily save each chunk.</li><li>Concatenates all chunks once complete and triggers a[download] with final file.</li><li>HTML5 Filesystem is marked deprecated but is still commonly in use.</li></ul><h2 id="usage">Usage</h2><h3 id="constructor">Constructor</h3><p>The Multithread constructor accepts a single object parameter:</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">new</span> <span class="nx">MultiThread</span><span class="p">({</span>
  <span class="na">url</span><span class="p">:</span> <span class="s1">'http://some-url/'</span><span class="p">,</span>    <span class="c1">// The request url</span>
  <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>                  <span class="c1">// Request headers to pass-though</span>
    <span class="s1">'Authorization'</span><span class="p">:</span> <span class="s2">`Bearer </span><span class="p">${</span><span class="nx">accessToken</span><span class="p">}</span><span class="s2">`</span>
  <span class="p">},</span>
  <span class="na">fileName</span><span class="p">:</span> <span class="s1">'some-file.ext'</span><span class="p">,</span>  <span class="c1">// The final output fileName</span>
  <span class="na">chunkSize</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>               <span class="c1">// Size of each chunk in MB</span>
  <span class="na">threads</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>                 <span class="c1">// Number of concurrent request threads</span>
  <span class="na">retries</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>                 <span class="c1">// Number of retry attempts</span>
  <span class="na">retryDelay</span><span class="p">:</span> <span class="mi">1000</span>            <span class="c1">// Delay before another retry attempt in ms</span>
<span class="p">})</span>
</code></pre></div></div><h3 id="callbacks">Callbacks</h3><p>Multithread triggers several events that you can attach callbacks to. The callbacks will be called with a single object consisting of the following keys:</p><ul><li>onStart({ contentLength, chunks })</li><li>onFinish({})</li><li>onProgress({ contentLength, loaded })</li><li>onError({ error })</li></ul><p>Each individual chunk will also trigger it’s own events:</p><ul><li>onChunkStart({ id })</li><li>onChunkFinish({ id })</li><li>onChunkProgress({ contentLength, loaded, id })</li><li>onChunkError({ id, error })</li></ul><p>PromiseQueue provides concurrency by using a queue of promises. It will automatically retry a configurable amount of times before triggering either an “onFinish” or “onError” event.</p><h2 id="demo">Demo</h2><p><a href="https://backblaze-b2-samples.github.io/multithreaded-downloader-js/examples/backblaze.html"> Backblaze B2 </a></p><p><a href="https://backblaze-b2-samples.github.io/multithreaded-downloader-js/examples/googleDrive.html"> Google Drive </a></p><p><a href="https://github.com/Backblaze-B2-Samples/multithreaded-downloader-js"> GitHub </a></p><h2 id="reference">Reference</h2><ul><li><a href="https://blog.ghaiklor.com/parallel-chunk-requests-in-a-browser-via-service-workers-7be10be2b75f">Parallel chunk requests in a browser via Service Workers</a></li><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Streams_API">Web Streams API</a></li><li><a href="https://streams.spec.whatwg.org/">Web Streams Spec</a></li><li><a href="https://github.com/mafintosh/browser-server">browser-server</a></li><li><a href="https://github.com/jonbern/fetch-retry">fetch-retry</a></li><li><a href="http://pipes.js.org/">Pipes.js</a></li></ul></div><div class="article__comments"></div> </article><footer class="footer"><div class="footer__container"> <a href="http://jekyllrb.com"> <img src="/advanced-static-site/assets/images/jekyll-logo.png" class="footer__logo-img" alt="Jekyll"> </a> <a href="https://webpack.js.org"> <img src="/advanced-static-site/assets/images/webpack.png" class="footer__logo-img" alt="Webpack"> </a> <a href="https://popmotion.io"> <img src="/advanced-static-site/assets/images/popmotion.png" class="footer__logo-img" alt="Popmotion"> </a></div> </footer></section> </main> <script>"use strict";"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("/advanced-static-site/service-worker.js").then(function(e){e.onupdatefound=function(){var n=e.installing;n.onstatechange=function(){switch(n.state){case"installed":navigator.serviceWorker.controller?console.log("New or updated content is available."):console.log("Content is now available offline!");break;case"redundant":console.error("The installing service worker became redundant.")}}}})["catch"](function(e){console.error("Error during service worker registration:",e)})})</script><script src="/advanced-static-site/assets/vendors-386169ad5451c3489f20.bundle.js"></script><script src="/advanced-static-site/assets/app-386169ad5451c3489f20.bundle.js"></script></body></html>